name: Test Patches

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  TestPlugins:
    if: github.repository == 'Vendicated/Vencord'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (dev branch)
        if: ${{ github.event_name == 'schedule' }}
        uses: actions/checkout@v4
        with:
          ref: dev

      - name: Checkout repository
        if: ${{ github.event_name == 'workflow_dispatch' }}
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Google Chrome
        id: setup-chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Build Vencord reporter version
        run: pnpm buildReporter

      - name: Create report
        timeout-minutes: 10
        run: |
          export PATH="$PWD/node_modules/.bin:$PATH"
          export CHROMIUM_BIN=${{ steps.setup-chrome.outputs.chrome-path }}

          esbuild scripts/generateReport.ts > dist/report.mjs
          node dist/report.mjs >> $GITHUB_STEP_SUMMARY
        env:
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

      - name: Create report (Canary)
        timeout-minutes: 10
        if: success() || failure()
        run: |
          export PATH="$PWD/node_modules/.bin:$PATH"
          export CHROMIUM_BIN=${{ steps.setup-chrome.outputs.chrome-path }}
          export USE_CANARY=true

          esbuild scripts/generateReport.ts > dist/report.mjs
          node dist/report.mjs >> $GITHUB_STEP_SUMMARY
        env:
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
